<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="critical-section"><meta name="keywords" content="rust, rustlang, rust-lang, critical_section"><title>critical_section - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../critical_section/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../critical_section/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate critical_section</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 1.1.1</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../critical_section/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">critical_section</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/critical_section/lib.rs.html#1-286">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="critical-section"><a href="#critical-section">critical-section</a></h2>
<p><a href="https://crates.io/crates/critical-section"><img src="https://img.shields.io/crates/d/critical-section.svg" alt="crates.io" /></a>
<a href="https://crates.io/crates/critical-section"><img src="https://img.shields.io/crates/v/critical-section.svg" alt="crates.io" /></a>
<a href="https://docs.rs/critical-section"><img src="https://docs.rs/critical-section/badge.svg" alt="Documentation" /></a></p>
<p>This project is developed and maintained by the <a href="https://github.com/rust-embedded/wg#the-hal-team">HAL team</a>.</p>
<p>A critical section that works everywhere!</p>
<p>When writing software for embedded systems, it’s common to use a “critical section”
as a basic primitive to control concurrency. A critical section is essentially a
mutex global to the whole process, that can be acquired by only one thread at a time.
This can be used to protect data behind mutexes, to <a href="https://github.com/embassy-rs/atomic-polyfill">emulate atomics</a> in
targets that don’t support them, etc.</p>
<p>There’s a wide range of possible implementations depending on the execution environment:</p>
<ul>
<li>For bare-metal single core, disabling interrupts globally.</li>
<li>For bare-metal multicore, acquiring a hardware spinlock and disabling interrupts globally.</li>
<li>For bare-metal using a RTOS, it usually provides library functions for acquiring a critical section, often named “scheduler lock” or “kernel lock”.</li>
<li>For bare-metal running in non-privileged mode, usually some system call is needed.</li>
<li>For <code>std</code> targets, acquiring a global <code>std::sync::Mutex</code>.</li>
</ul>
<p>Libraries often need to use critical sections, but there’s no universal API for this in <code>core</code>. This leads
library authors to hardcode them for their target, or at best add some <code>cfg</code>s to support a few targets.
This doesn’t scale since there are many targets out there, and in the general case it’s impossible to know
which critical section implementation is needed from the Rust target alone. For example, the <code>thumbv7em-none-eabi</code> target
could be cases 1-4 from the above list.</p>
<p>This crate solves the problem by providing this missing universal API.</p>
<ul>
<li>It provides functions <code>acquire</code>, <code>release</code> and <code>with</code> that libraries can directly use.</li>
<li>It provides a way for any crate to supply an implementation. This allows “target support” crates such as architecture crates (<code>cortex-m</code>, <code>riscv</code>), RTOS bindings, or HALs for multicore chips to supply the correct implementation so that all the crates in the dependency tree automatically use it.</li>
</ul>
<h3 id="usage-in-no-std-binaries"><a href="#usage-in-no-std-binaries">Usage in <code>no-std</code> binaries.</a></h3>
<p>First, add a dependency on a crate providing a critical section implementation. Enable the <code>critical-section-*</code> Cargo feature if required by the crate.</p>
<p>Implementations are typically provided by either architecture-support crates (<code>cortex-m</code>, <code>riscv</code>, etc), or HAL crates.</p>
<p>For example, for single-core Cortex-M targets, you can use:</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
cortex-m = { version = &quot;0.7.6&quot;, features = [&quot;critical-section-single-core&quot;]}</code></pre></div>
<p>Then you can use <code>critical_section::with()</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">core::cell::Cell</span>;
<span class="kw">use</span> <span class="ident">critical_section::Mutex</span>;

<span class="kw">static</span> <span class="ident">MY_VALUE</span>: <span class="ident">Mutex</span><span class="op">&lt;</span><span class="ident">Cell</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Mutex::new</span>(<span class="ident">Cell::new</span>(<span class="number">0</span>));

<span class="ident">critical_section::with</span>(<span class="op">|</span><span class="ident">cs</span><span class="op">|</span> {
    <span class="comment">// This code runs within a critical section.</span>

    <span class="comment">// `cs` is a token that you can use to &quot;prove&quot; that to some API,</span>
    <span class="comment">// for example to a `Mutex`:</span>
    <span class="ident">MY_VALUE</span>.<span class="ident">borrow</span>(<span class="ident">cs</span>).<span class="ident">set</span>(<span class="number">42</span>);
});
</code></pre></div>
<h3 id="usage-in-std-binaries"><a href="#usage-in-std-binaries">Usage in <code>std</code> binaries.</a></h3>
<p>Add the <code>critical-section</code> dependency to <code>Cargo.toml</code> enabling the <code>std</code> feature. This makes the <code>critical-section</code> crate itself
provide an implementation based on <code>std::sync::Mutex</code>, so you don’t have to add any other dependency.</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
critical-section = { version = &quot;1.1&quot;, features = [&quot;std&quot;]}</code></pre></div><h3 id="usage-in-libraries"><a href="#usage-in-libraries">Usage in libraries</a></h3>
<p>If you’re writing a library intended to be portable across many targets, simply add a dependency on <code>critical-section</code>
and use <code>critical_section::free</code> and/or <code>Mutex</code> as usual.</p>
<p><strong>Do not</strong> add any dependency supplying a critical section implementation. Do not enable any <code>critical-section-*</code> Cargo feature.
This has to be done by the end user, enabling the correct implementation for their target.</p>
<p><strong>Do not</strong> enable any Cargo feature in <code>critical-section</code>.</p>
<h3 id="usage-in-std-tests-for-no-std-libraries"><a href="#usage-in-std-tests-for-no-std-libraries">Usage in <code>std</code> tests for <code>no-std</code> libraries.</a></h3>
<p>If you want to run <code>std</code>-using tests in otherwise <code>no-std</code> libraries, enable the <code>std</code> feature in <code>dev-dependencies</code> only.
This way the main target will use the <code>no-std</code> implementation chosen by the end-user’s binary, and only the test targets
will use the <code>std</code> implementation.</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
critical-section = &quot;1.1&quot;

[dev-dependencies]
critical-section = { version = &quot;1.1&quot;, features = [&quot;std&quot;]}</code></pre></div><h3 id="providing-an-implementation"><a href="#providing-an-implementation">Providing an implementation</a></h3>
<p>Crates adding support for a particular architecture, chip or operating system should provide a critical section implementation.
It is <strong>strongly recommended</strong> to gate the implementation behind a feature, so the user can still use another implementation
if needed (having two implementations in the same binary will cause linking to fail).</p>
<p>Add the dependency, and a <code>critical-section-*</code> feature to your <code>Cargo.toml</code>:</p>
<div class="example-wrap"><pre class="language-toml"><code>[features]
critical-section-foo = [&quot;critical-section/restore-state-bool&quot;]

[dependencies]
critical-section = { version = &quot;1.0&quot;, optional = true }</code></pre></div>
<p>Then, provide the critical implementation like this:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// This is a type alias for the enabled `restore-state-*` feature.</span>
<span class="comment">// For example, it is `bool` if you enable `restore-state-bool`.</span>
<span class="kw">use</span> <span class="ident">critical_section::RawRestoreState</span>;

<span class="kw">struct</span> <span class="ident">MyCriticalSection</span>;
<span class="macro">critical_section::set_impl!</span>(<span class="ident">MyCriticalSection</span>);

<span class="kw">unsafe</span> <span class="kw">impl</span> <span class="ident">critical_section::Impl</span> <span class="kw">for</span> <span class="ident">MyCriticalSection</span> {
    <span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">acquire</span>() -&gt; <span class="ident">RawRestoreState</span> {
        <span class="comment">// TODO</span>
    }

    <span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">release</span>(<span class="ident">token</span>: <span class="ident">RawRestoreState</span>) {
        <span class="comment">// TODO</span>
    }
}</code></pre></div>
<h3 id="troubleshooting"><a href="#troubleshooting">Troubleshooting</a></h3><h4 id="undefined-reference-errors"><a href="#undefined-reference-errors">Undefined reference errors</a></h4>
<p>If you get an error like these:</p>
<div class="example-wrap"><pre class="language-not_rust"><code>undefined reference to `_critical_section_1_0_acquire&#39;
undefined reference to `_critical_section_1_0_release&#39;</code></pre></div>
<p>it is because you (or a library) are using <code>critical_section::with</code> without providing a critical section implementation.
Make sure you’re depending on a crate providing the implementation, and have enabled the <code>critical-section-*</code> feature in it if required. See the <code>Usage</code> section above.</p>
<p>The error can also be caused by having the dependency but never <code>use</code>ing it. This can be fixed by adding a dummy <code>use</code>:</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code><span class="kw">use</span> <span class="ident">the_cs_impl_crate</span> <span class="kw">as</span> <span class="kw">_</span>;</code></pre></div>
<h4 id="duplicate-symbol-errors"><a href="#duplicate-symbol-errors">Duplicate symbol errors</a></h4>
<p>If you get errors like these:</p>
<div class="example-wrap"><pre class="language-not_rust"><code>error: symbol `_critical_section_1_0_acquire` is already defined</code></pre></div>
<p>it is because you have two crates trying to provide a critical section implementation. You can only
have one implementation in a program.</p>
<p>You can use <code>cargo tree --format '{p} {f}'</code> to view all dependencies and their enabled features. Make sure
that in the whole dependency tree, exactly one implementation is provided.</p>
<p>Check for multiple versions of the same crate as well. For example, check the <code>critical-section-single-core</code>
feature is not enabled for both <code>cortex-m</code> 0.7 and 0.8.</p>
<h3 id="why-not-generics"><a href="#why-not-generics">Why not generics?</a></h3>
<p>An alternative solution would be to use a <code>CriticalSection</code> trait, and make all
code that needs acquiring the critical section generic over it. This has a few problems:</p>
<ul>
<li>It would require passing it as a generic param to a very big amount of code, which
would be quite unergonomic.</li>
<li>It’s common to put <code>Mutex</code>es in <code>static</code> variables, and <code>static</code>s can’t
be generic.</li>
<li>It would allow mixing different critical section implementations in the same program,
which would be unsound.</li>
</ul>
<h3 id="minimum-supported-rust-version-msrv"><a href="#minimum-supported-rust-version-msrv">Minimum Supported Rust Version (MSRV)</a></h3>
<p>This crate is guaranteed to compile on the following Rust versions:</p>
<ul>
<li>If the <code>std</code> feature is not enabled: stable Rust 1.54 and up.</li>
<li>If the <code>std</code> feature is enabled: stable Rust 1.63 and up.</li>
</ul>
<p>It might compile with older versions but that may change in any new patch release.</p>
<p>See <a href="docs/msrv.md">here</a> for details on how the MSRV may be upgraded.</p>
<h3 id="license"><a href="#license">License</a></h3>
<p>This work is licensed under either of</p>
<ul>
<li>Apache License, Version 2.0 (<a href="LICENSE-APACHE">LICENSE-APACHE</a> or
<a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>)</li>
<li>MIT license (<a href="LICENSE-MIT">LICENSE-MIT</a> or <a href="http://opensource.org/licenses/MIT">http://opensource.org/licenses/MIT</a>)</li>
</ul>
<p>at your option.</p>
<h3 id="contribution"><a href="#contribution">Contribution</a></h3>
<p>Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall be
dual licensed as above, without any additional terms or conditions.</p>
<h3 id="code-of-conduct"><a href="#code-of-conduct">Code of Conduct</a></h3>
<p>Contribution to this crate is organized under the terms of the <a href="CODE_OF_CONDUCT.md">Rust Code of
Conduct</a>, the maintainer of this crate, the <a href="https://github.com/rust-embedded/wg#the-hal-team">HAL team</a>, promises
to intervene to uphold that code of conduct.</p>
</div></details><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.set_impl.html" title="critical_section::set_impl macro">set_impl</a></div><div class="item-right docblock-short"><p>Set the critical section implementation.</p>
</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.CriticalSection.html" title="critical_section::CriticalSection struct">CriticalSection</a></div><div class="item-right docblock-short"><p>Critical section token.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Mutex.html" title="critical_section::Mutex struct">Mutex</a></div><div class="item-right docblock-short"><p>A mutex based on critical sections.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RestoreState.html" title="critical_section::RestoreState struct">RestoreState</a></div><div class="item-right docblock-short"><p>Opaque “restore state”.</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Impl.html" title="critical_section::Impl trait">Impl</a></div><div class="item-right docblock-short"><p>Methods required for a critical section implementation.</p>
</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.acquire.html" title="critical_section::acquire fn">acquire</a><a title="unsafe function" href="#"><sup>⚠</sup></a></div><div class="item-right docblock-short"><p>Acquire a critical section in the current thread.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.release.html" title="critical_section::release fn">release</a><a title="unsafe function" href="#"><sup>⚠</sup></a></div><div class="item-right docblock-short"><p>Release the critical section.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.with.html" title="critical_section::with fn">with</a></div><div class="item-right docblock-short"><p>Execute closure <code>f</code> in a critical section.</p>
</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="type" href="type.RawRestoreState.html" title="critical_section::RawRestoreState type">RawRestoreState</a></div><div class="item-right docblock-short"><p>Raw, transparent “restore state”.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="critical_section" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.64.0" ></div></body></html>