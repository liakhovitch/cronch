<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Universal Serial Bus (USB)"><meta name="keywords" content="rust, rustlang, rust-lang, usb"><title>rp2040_hal::usb - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../rp2040_hal/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../rp2040_hal/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module usb</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../rp2040_hal/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../index.html">rp2040_hal</a>::<wbr><a class="mod" href="#">usb</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../src/rp2040_hal/usb.rs.html#1-684">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Universal Serial Bus (USB)</p>
<h3 id="usage"><a href="#usage">Usage</a></h3>
<p>Initialize the Usb Bus forcing the VBUS detection.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">rp2040_hal</span>::{<span class="ident">clocks::init_clocks_and_plls</span>, <span class="ident">pac</span>, <span class="ident">Sio</span>, <span class="ident">usb::UsbBus</span>, <span class="ident">watchdog::Watchdog</span>};
<span class="kw">use</span> <span class="ident">usb_device::class_prelude::UsbBusAllocator</span>;

<span class="kw">const</span> <span class="ident">XOSC_CRYSTAL_FREQ</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">12_000_000</span>; <span class="comment">// Typically found in BSP crates</span>

<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">pac</span> <span class="op">=</span> <span class="ident">pac::Peripherals::take</span>().<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">watchdog</span> <span class="op">=</span> <span class="ident">Watchdog::new</span>(<span class="ident">pac</span>.<span class="ident">WATCHDOG</span>);
<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">clocks</span> <span class="op">=</span> <span class="ident">init_clocks_and_plls</span>(
    <span class="ident">XOSC_CRYSTAL_FREQ</span>,
    <span class="ident">pac</span>.<span class="ident">XOSC</span>,
    <span class="ident">pac</span>.<span class="ident">CLOCKS</span>,
    <span class="ident">pac</span>.<span class="ident">PLL_SYS</span>,
    <span class="ident">pac</span>.<span class="ident">PLL_USB</span>,
    <span class="kw-2">&amp;mut</span> <span class="ident">pac</span>.<span class="ident">RESETS</span>,
    <span class="kw-2">&amp;mut</span> <span class="ident">watchdog</span>
).<span class="ident">ok</span>().<span class="ident">unwrap</span>();

<span class="kw">let</span> <span class="ident">usb_bus</span> <span class="op">=</span> <span class="ident">UsbBusAllocator::new</span>(<span class="ident">UsbBus::new</span>(
        <span class="ident">pac</span>.<span class="ident">USBCTRL_REGS</span>,
        <span class="ident">pac</span>.<span class="ident">USBCTRL_DPRAM</span>,
        <span class="ident">clocks</span>.<span class="ident">usb_clock</span>,
        <span class="bool-val">true</span>,
        <span class="kw-2">&amp;mut</span> <span class="ident">pac</span>.<span class="ident">RESETS</span>,
    ));
<span class="comment">// Use the usb_bus as usual.</span></code></pre></div>
<p>See <a href="https://github.com/rp-rs/rp-hal/tree/main/boards/pico/examples/pico_usb_serial.rs">pico_usb_serial.rs</a> for more complete examples</p>
<h3 id="enumeration-issue-with-small-ep0-max-packet-size"><a href="#enumeration-issue-with-small-ep0-max-packet-size">Enumeration issue with small EP0 max packet size</a></h3>
<p>During enumeration Windows hosts send a <code>StatusOut</code> after the <code>DataIn</code> packet of the first
<code>Get Descriptor</code> resquest even if the <code>DataIn</code> isn’t completed (typically when the <code>max_packet_size_ep0</code>
is less than 18bytes). The next request is a <code>Set Address</code> that expect a <code>StatusIn</code>.</p>
<p>The issue is that by the time the previous <code>DataIn</code> packet is acknoledged and the <code>StatusOut</code>
followed by <code>Setup</code> are received, the usb stack may have already prepared the next <code>DataIn</code> payload
in the EP0 IN mailbox resulting in the payload being transmitted to the host instead of the
<code>StatusIn</code> for the <code>Set Address</code> request as expected by the host.</p>
<p>To avoid that issue, the EP0 In mailbox should be invalidated between the <code>Setup</code> packet and the
next <code>StatusIn</code> initiated by the host. The workaround implemented clears the available bit of the
EP0 In endpoint’s buffer to stop the device from sending the data instead of the status packet.
This workaround has the caveat that the poll function must be called between those two which
are only separated by a few microseconds.</p>
<p>If the required timing cannot be met, using an maximum packet size of the endpoint 0 above 18bytes
(e.g. <code>.max_packet_size_ep0(64)</code>) should avoid that issue.</p>
<h3 id="issue-on-rp2040b0-and-rp2040b1-usb-device-fails-to-exit-reset-state-on-busy-usb-bus"><a href="#issue-on-rp2040b0-and-rp2040b1-usb-device-fails-to-exit-reset-state-on-busy-usb-bus">Issue on RP2040B0 and RP2040B1: USB device fails to exit RESET state on busy USB bus.</a></h3>
<p>The feature <code>rp2040-e5</code>implements the workaround described by <a href="https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf#%5B%7B%22num%22%3A630%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C158.848%2Cnull%5D">RP2040-E5</a>.</p>
<p>The workaround requires the GPIO block to be released from its reset and has for side effect
that GPIO15 will be stolen for a few hundred microseconds each time a Reset is detected on the
USB bus.</p>
<p>The pin will be temporarily put in “bus keep” mode, weakly pulling the output towards its current
logic level. In absence of external loads, the current logic level will be maintained.
A user will lose control of the pin’s output and reading from it may not reflect the actual state
of the external pin.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">rp2040_hal</span>::{<span class="ident">gpio::Pins</span>, <span class="ident">Sio</span>};

<span class="comment">// required for the errata 5&#39;s workaround to function properly.</span>
<span class="kw">let</span> <span class="ident">sio</span> <span class="op">=</span> <span class="ident">Sio::new</span>(<span class="ident">pac</span>.<span class="ident">SIO</span>);
<span class="kw">let</span> <span class="ident">_pins</span> <span class="op">=</span> <span class="ident">Pins::new</span>(
    <span class="ident">pac</span>.<span class="ident">IO_BANK0</span>,
    <span class="ident">pac</span>.<span class="ident">PADS_BANK0</span>,
    <span class="ident">sio</span>.<span class="ident">gpio_bank0</span>,
    <span class="kw-2">&amp;mut</span> <span class="ident">pac</span>.<span class="ident">RESETS</span>,
);</code></pre></div>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.UsbBus.html" title="rp2040_hal::usb::UsbBus struct">UsbBus</a></div><div class="item-right docblock-short"><p>Usb bus</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="rp2040_hal" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.64.0" ></div></body></html>